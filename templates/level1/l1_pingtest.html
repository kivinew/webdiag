{% extends 'base.html' %}

{% block styles %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/levels.css') }}">
    <style>
        .diagnostics { padding: 20px; }
        .form-group { margin-bottom: 14px; }
        .result-container { margin-top: 24px; border-radius: 6px; background: #fafbfc; padding: 16px 22px; }
        .status-ok { color: #2b9e43; font-weight: bold; }
        .status-fail { color: #c92332; font-weight: bold; }
        .result { font-size: 1.08em; line-height: 1.7; }
        .btn-check, .btn-clear { margin-right: 8px; }
        button { font-size: 1em; }
        @media (max-width: 700px) {
            .diagnostics { padding: 8px; font-size: 1em; }
            .result-container { padding: 8px; }
        }
        .ip-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ip-input-wrap {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ip-input-wrap input {
            flex: 1 1 auto;
        }
    </style>
{% endblock %}

{% block content %}
{{ super() }}

<div class="diagnostics">
    <h2>Проверка доступности сети</h2>
    <form id="terminalForm" onsubmit="runDiagnostics(); return false;">
        <div class="form-group">
            <label for="oltSelect">Головная станция:</label>
            <select id="oltSelect" name="olt">
                {% for ip, name in HUAWEI_OLT.items() %}
                    <option value="{{ ip }}">{{ name }} ({{ ip }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="serialInput">Серийный номер ONT:</label>
            <input class="serialInput"
                id="serialInput"
                type="text"
                name="serial"
                placeholder="4857544312345678"
                required
                pattern="[A-Za-z0-9]{8,16}"
                autocomplete="on" />
        </div>
        <div class="form-group">
            <label for="requestData">IP-адрес:</label>
            <input class="requestData"
                id="requestData"
                type="text"
                name="host"
                placeholder="например, 8.8.8.8"
                required
                pattern="[-0-9.]{7,15}"
                autocomplete="on" />
                <button type="submit" class="btn-check">Проверить связь</button>
                <button type="button" onclick="clearForm()" class="btn-check">Очистить</button>
        </div>
    </form>

    <div class="result-container" id="resultContainer" style="display:none;">
        <h3>Результат:</h3>
        <div class="result result-field" id="resultDescription"></div>
        <div style="margin: 10px 0 0;">
            <strong>Доступ в интернет:</strong>
            <span id="resultOnt" class="status-ok"></span>
        </div>
        <button type="button" style="margin-top:10px" onclick="copyResult()">Копировать результат</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const form = document.getElementById('terminalForm');
const serialInput = document.getElementById('serialInput');
const hostInput = document.getElementById('requestData');
const resultContainer = document.getElementById('resultContainer');
const resultDesc = document.getElementById('resultDescription');
const resultOnt = document.getElementById('resultOnt');
const btnCheck = document.querySelector('.btn-check');

function clearForm() {
    serialInput.value = '';
    hostInput.value = '';
    resultDesc.textContent = '';
    resultOnt.textContent = '';
    resultContainer.style.display = 'none';
}

// При копировании забирает только видимые параметры:
function copyResult() {
    let txt = resultDesc.textContent + '\nДоступ в интернет: ' + resultOnt.textContent;
    navigator.clipboard.writeText(txt);
}

async function runDiagnostics() {
    if (!form.reportValidity()) return;
    const serial = serialInput.value.trim();
    const host = hostInput.value.trim();
    resultContainer.style.display = 'block';
    resultDesc.textContent = 'Выполняется...';
    resultOnt.textContent = '';

    btnCheck.disabled = true;
    try {
        const oltIp = document.getElementById('oltSelect').value;
        const resp = await fetch('/api/ping', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ host, serial, olt_ip: oltIp })
        });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();
        // Если backend сразу возвращает корневые параметры (как рекомендовано) — используем их:
        const ping = data.output || data;   // считает вложенность
        const ip = (typeof ping.ip === 'string') ? ping.ip : '-';
        const received = typeof ping.received === 'number' ? ping.received : Number(ping.received) || 0;
        const lost = typeof ping.lost === 'number' ? ping.lost : Number(ping.lost) || '-';
        const netstatus = (ping.ok && received > 0 && lost === 0) ? 'OK' : 'ОТСУТСТВУЕТ!';

        resultDesc.textContent = `IP: ${ip} Получено: ${received} Потери: ${lost}`;
        resultOnt.textContent = netstatus;
        resultOnt.className = netstatus === 'OK' ? 'status-ok' : 'status-fail';


    } catch (e) {
        resultOnt.textContent = 'Ошибка';
        resultOnt.className = 'status-fail';
        resultDesc.textContent = 'Ошибка запроса: ' + e.message;
    } finally {
        btnCheck.disabled = false;
    }
}
</script>
{% endblock %}
