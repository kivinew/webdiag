{% extends 'base.html' %}

{% block styles %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/levels.css') }}">
    <style>
        #resultDescription { white-space: pre-wrap; }
        .status-ok { color: #2b9e43; font-weight: bold; }
        .status-fail { color: #c92332; font-weight: bold; }
        .form-group { margin-bottom: 12px; display: flex; flex-wrap: wrap; gap: 20px 24px;}
        .form-group label { min-width: 170px; }
        .form-group select, .form-group input { min-width: 200px; max-width: 350px; }
        .result-field { margin-top: 6px; }
        .field-label { display: inline-block; min-width: 120px; font-weight: bold;}
        .loader {
            display: inline-block;
            width: 20px; height: 20px;
            border: 2px solid #999; border-top: 2px solid #eee;
            border-radius: 50%; animation: spin 1s linear infinite; vertical-align: middle;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .btn-check, .btn-clear { margin-right: 8px; }
        @media (max-width: 700px) {
            .diagnostics { padding: 8px; font-size: 1em; }
            .form-group { flex-direction: column; gap: 8px 0;}
            .form-group select, .form-group input { min-width: 120px; max-width: 94vw;}
        }
    </style>
{% endblock %}

{% block content %}
{{ super() }}

<div class="diagnostics">
    <h2>Проверка доступности сети с терминала абонента</h2>
    <form id="terminalForm" onsubmit="runDiagnostics(); return false;">
        <div class="form-group">
            <label for="oltSelect">Головная станция:</label>
            <select id="oltSelect" name="olt">
                {% for ip, name in HUAWEI_OLT.items() %}
                    <option value="{{ ip }}">{{ ip }} {{ name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="serialInput">Серийный номер ONT:</label>
            <input class="serialInput"
                   id="serialInput"
                   type="text"
                   name="serial"
                   placeholder="4857544312345678"
                   required
                   pattern="[A-Za-z0-9.\-]{1,253}"
                   autocomplete="on"
                   title="8–16 символов: буквы или цифры"/>
        </div>
        <div class="form-group">
            <label for="requestData">Домен/IP:</label>
            <input class="requestData"
                   id="requestData"
                   type="text"
                   name="host"
                   placeholder="например, 8.8.8.8 или example.com"
                   required
                   autocomplete="on"
                   title="Допустимы буквы, цифры, точка и дефис (1–253 символа)"/>
        </div>
        <div style="margin-top: 8px;">
            <button type="submit" class="btn-check">Проверить связь</button>
            <button type="button" onclick="clearForm()" class="btn-clear">Очистить</button>
        </div>
    </form>

    <div class="result-container" id="resultContainer" style="display:none;">
        <h3>Результат:</h3>
        <div class="result-field">
            <span class="field-label">Хост/IP:</span>
            <span id="resultSerial" class="field-value"></span>
        </div>
        <div class="result-field">
            <span class="field-label">Результат:</span>
            <span id="resultDescription" class="field-value"></span>
        </div>
        <div class="result-field">
            <span class="field-label">Доступ в интернет:</span>
            <span id="resultOnt" class="field-value"></span>
        </div>
        <button type="button" style="margin-top:8px" onclick="copyResult()">Копировать результат</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const form = document.getElementById('terminalForm');
const serialInput = document.querySelector('.serialInput');
const hostInput = document.getElementById('requestData');
const resultContainer = document.getElementById('resultContainer');
const resultSerial = document.getElementById('resultSerial');
const resultDesc = document.getElementById('resultDescription');
const resultOnt = document.getElementById('resultOnt');
const btnCheck = document.querySelector('.btn-check');

function clearForm() {
  serialInput.value = '';
  hostInput.value = '';
  resultSerial.textContent = '';
  resultDesc.textContent = '';
  resultOnt.textContent = '';
  resultContainer.style.display = 'none';
}

function copyResult() {
  let txt = `Хост/IP: ${resultSerial.textContent}\nДоступ в интернет: ${resultOnt.textContent}\n${resultDesc.textContent}`;
  navigator.clipboard.writeText(txt);
}

async function runDiagnostics() {
    if (!form.reportValidity()) return;
    const serial = serialInput.value.trim();
    const host = hostInput.value.trim();
    resultContainer.style.display = 'block';
    resultSerial.textContent = host;
    resultOnt.innerHTML = '<span class="loader"></span> Выполняется...';
    resultDesc.textContent = '';

    btnCheck.disabled = true;
    try {
        const oltIp = document.getElementById('oltSelect').value;
        const resp = await fetch('/api/ping', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ host, serial, olt_ip: oltIp })
        });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();

        // Берём результат из data.output или прямо из data, если переписал парсер согласно предыдущим рекомендациям
        let ping = data.output || data; 
        
        // Забираем только нужные поля
        let ip = (typeof ping.ip === 'string') ? ping.ip : 'нет';
        let received = ping.received !== undefined ? Number(ping.received) : 0;
        let lost = ping.lost !== undefined ? Number(ping.lost) : '-';

        // Для ясности: количество отправленных пакетов (обычно 4 или 10)
        let sentMatch = (ping.output || ping.raw || ping).match && (ping.output || ping.raw || ping).match(/Transmit packets\s*:\s*(\d+)/);
        let sent = sentMatch ? Number(sentMatch[1]) : undefined;
        // Если нет — можно забыть/убрать, если не требуется вывести "отправлено"

        // Показываем только IP, получено, отправлено, и статус
        let netstatus = (data.ok && received > 0 && lost === 0) ? 'OK' : 'FAIL';
        resultOnt.textContent = netstatus;
        resultOnt.className = netstatus === 'OK' ? 'status-ok' : 'status-fail';

        // Составляем строку только из нужных данных:
        let out = `IP: ${ip}\nПолучено: ${received}\nПотери: ${lost}\nСтатус: ${netstatus}`;
        resultDesc.textContent = out;

    } catch (e) {
        resultOnt.textContent = 'Ошибка';
        resultOnt.className = 'status-fail';
        resultDesc.textContent = 'Ошибка запроса: ' + e.message;
    }
}

</script>
{% endblock %}
