{% extends 'base.html' %}

{% block styles %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/levels.css') }}">
<style>
    .diagnostics {
        max-width: 1200px;
        margin: 40px auto;
        padding: 24px 28px;
        border-radius: 8px;
        background: #f5fbff;
        box-shadow: 0 4px 18px rgba(0,0,0,0.25);
        font-size: 15px;
        }

        /* две колонки: форма + правый блок */
        .diag-layout {
        display: flex;
        gap: 24px;
        align-items: flex-start;
        }

        /* левая колонка с формой */
        .diag-left {
        flex: 1 1 0;
        }

        /* правая колонка с результатом фиксированной ширины */
        .diag-right {
        flex: 0 0 260px;
        padding: 14px 16px;
        border-radius: 6px;
        background: #ffffff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* заголовки */
        .diag-left h4,
        .diag-right h4 {
        margin: 0 0 10px;
        }

        /* строки формы */
        #terminalForm {
        margin-top: 16px;
        }

        .form-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
        }

        .form-group label {
        flex: 0 0 180px;
        font-weight: 500;
        }

        /* селект и инпуты */
        .form-group select,
        .form-group input {
        flex: 1 1 auto;
        max-width: 380px;
        padding: 6px 8px;
        border-radius: 4px;
        border: 1px solid #bcc9d6;
        font-size: 14px;
        }

        /* IP + кнопки в одну линию */
        .ip-row { align-items: flex-start; }

        .ip-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1 1 auto;
        }

        .ip-controls input {
        flex: 1 1 auto;
        }

        /* кнопки */
        .btn {
        padding: 7px 14px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        white-space: nowrap;
        }

        .btn.primary {
        background: #1b6da8;
        color: #fff;
        }

        .btn.primary:hover { background: #155683; }

        .btn.secondary {
        background: #e3e9f0;
        color: #243447;
        }

        .btn.secondary:hover { background: #d4dde8; }

        .btn.full {
        width: 100%;
        margin-top: 10px;
        }

        /* текст результата */
        .result-text {
        margin-bottom: 10px;
        white-space: pre-line;
        }

        .result-status {
        margin-top: 4px;
        }

        .status-ok   { color: #2b9e43; font-weight: bold; }
        .status-fail { color: #c92332; font-weight: bold; }

        /* адаптив – на узких экранах правая колонка уходит под форму */
        @media (max-width: 900px) {
        .diag-layout {
            flex-direction: column;
        }
        .diag-right {
            width: 100%;
            flex: 0 0 auto;
        }
        .form-group {
            flex-direction: column;
            align-items: flex-start;
        }
        .form-group label {
            flex: 0 0 auto;
        }
        .form-group select,
        .form-group input {
            max-width: 100%;
            width: 100%;
        }
        .ip-controls {
            flex-direction: column;
            align-items: stretch;
        }
        .ip-controls .btn {
            width: 100%;
        }
    }

</style>
{% endblock %}

{% block content %}
{{ super() }}

<div class="diagnostics">
  <div class="diag-layout">
    <div class="diag-left">
      <h4>Проверка работы сети</h4>
      <div>Выбери головную станцию (населённый пункт), укажи серийный номер терминала из УУ</div>
      <div>Нажми кнопку "Проверить сеть"</div>
      <div>Ожидай результат проверки</div>

      <form id="terminalForm" onsubmit="runDiagnostics(); return false;">
        <div class="form-group">
          <label for="oltSelect">Головная станция:</label>
          <select id="oltSelect" name="olt">
            {% for ip, name in HUAWEI_OLT.items() %}
              <option value="{{ ip }}">{{ name }} ({{ ip }})</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label for="serialInput">Серийный номер ONT:</label>
          <input class="serialInput"
                 id="serialInput"
                 type="text"
                 name="serial"
                 placeholder="4857544312345678"
                 required
                 pattern="[A-Za-z0-9]{8,16}"
                 autocomplete="on" />
        </div>
        <div class="form-group ip-row">
          <label for="requestData">IP-адрес:</label>
          <div class="ip-controls">
            <input class="requestData"
                   id="requestData"
                   type="text"
                   name="host"
                   placeholder="например, 8.8.8.8"
                   required
                   pattern="[0-9.-]{7,15}"
                   autocomplete="on" />
            <button type="submit" class="btn-check">Проверить связь</button>
            <button type="button" onclick="clearForm()" class="btn secondary">Очистить</button>
          </div>
        </div>
      </form>
    </div>

    <aside class="diag-right" id="resultContainer" style="display:none;">
      <h4>Результат:</h4>
      <div id="resultDescription" class="result-text"></div>
      <div class="result-status">
        <strong>Доступ в интернет:</strong>
        <span id="resultOnt" class="status-ok"></span>
      </div>
      <button type="button" class="btn secondary full" onclick="copyResult()">Копировать результат</button>
    </aside>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const form = document.getElementById('terminalForm');
const serialInput = document.getElementById('serialInput');
const hostInput = document.getElementById('requestData');
const resultContainer = document.getElementById('resultContainer');
const resultDesc = document.getElementById('resultDescription');
const resultOnt = document.getElementById('resultOnt');
const btnCheck = document.querySelector('.btn-check');

function clearForm() {
    serialInput.value = '';
    hostInput.value = '';
    resultDesc.textContent = '';
    resultOnt.textContent = '';
    resultContainer.style.display = 'none';
}

// При копировании забирает только видимые параметры:
function copyResult() {
    let txt = resultDesc.textContent + '\nДоступ в интернет: ' + resultOnt.textContent;
    navigator.clipboard.writeText(txt);
}

async function runDiagnostics() {
    if (!form.reportValidity()) return;
    const serial = serialInput.value.trim();
    const host = hostInput.value.trim();
    resultContainer.style.display = 'block';
    resultDesc.textContent = 'Выполняется проверка...';
    resultOnt.textContent = '';

    btnCheck.disabled = true;
    try {
        const oltIp = document.getElementById('oltSelect').value;
        const resp = await fetch('/api/ping', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ host, serial, olt_ip: oltIp })
        });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();
        // Если backend сразу возвращает корневые параметры (как рекомендовано) — используем их:
        const ping = data.output || data;   // считает вложенность
        const ip = (typeof ping.ip === 'string') ? ping.ip : '-';
        const received = typeof ping.received === 'number' ? ping.received : Number(ping.received) || 0;
        const lost = typeof ping.lost === 'number' ? ping.lost : Number(ping.lost) || '-';
        const netstatus = (ping.ok && received > 0 && lost === 0) ? 'OK' : 'ОТСУТСТВУЕТ!';

        resultDesc.textContent = `IP: ${ip} Получено: ${received} Потери: ${lost}`;
        resultOnt.textContent = netstatus;
        resultOnt.className = netstatus === 'OK' ? 'status-ok' : 'status-fail';


    } catch (e) {
        resultOnt.textContent = 'Ошибка';
        resultOnt.className = 'status-fail';
        resultDesc.textContent = 'Ошибка запроса: ' + e.message;
    } finally {
        btnCheck.disabled = false;
    }
}
</script>
{% endblock %}
